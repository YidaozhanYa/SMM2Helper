# Maintainer: YidaozhanYa <yidaozhan_ya@outlook.com>

pkgname=smm2helper-git
_pkgname=smm2helper
pkgver=v1.2.r0.g6fad88a
pkgrel=1
pkgdesc="SMM2 Course World browser, graphical frontend for TheGreatRambler's SMM2 API"
license=('MIT')
depends=('python' 'python-gobject' 'python-pycryptodome' 'python-pywebview' 'python-requests' 'python-pyclip')
makedepends=('python')
arch=('any')
url='https://github.com/YidaozhanYa/SMM2Helper'
source=('git+https://github.com/YidaozhanYa/SMM2Helper.git'
        "${_pkgname}.desktop"
        "${_pkgname}")
sha256sums=('SKIP'
            '26ec62e9b6c3a6d60908406f57083c65030b4b29a0ffd84b42397954ad89720f'
            'b86b76f10f5ccf7b5f878abde73ea1c12eac6500c84747a9344668ad9e7e99ed')

pkgver() {
    cd "$srcdir/SMM2Helper"
    git describe --long --tags | sed 's/\([^-]*-g\)/r\1/;s/-/./g' | sed 's/lastlocal.//'
}

package() {
    cd "${srcdir}/SMM2Helper"
    mkdir -p "${pkgdir}/usr/lib/${_pkgname}"
    ./download-requirements.sh
    for file in config.py smm2helper.py tgrcode_api.py widgets.py SMM2 web; do
        cp -r "${file}" "${pkgdir}/usr/lib/${_pkgname}/${file}"
    done
    python -m venv "${pkgdir}/usr/lib/${_pkgname}/venv" --system-site-packages
    "${pkgdir}/usr/lib/${_pkgname}/venv/bin/pip3" install nintendoclients==0.0.3
    "${pkgdir}/usr/lib/${_pkgname}/venv/bin/pip3" uninstall setuptools -y
    if [ -d "${pkgdir}/usr/lib/${_pkgname}/SMM2/__pycache__" ]; then
        rm -rf "${pkgdir}/usr/lib/${_pkgname}/SMM2/__pycache__"
    fi
    install -Dm644 -t "${pkgdir}/usr/share/applications" "${srcdir}/${_pkgname}.desktop"
    install -Dm644 "res/${_pkgname}.png" "$pkgdir/usr/share/icons/hicolor/512x512/apps/${_pkgname}.png"
    install -Dm755 "${srcdir}/${_pkgname}" "${pkgdir}/usr/bin/${_pkgname}"
	install -Dm644 "LICENSE" "${pkgdir}/usr/share/licenses/${pkgname}"
}
